<?php

namespace App\Http\Controllers\Auth;

use App\Helpers\GeoHelper;
use App\Http\Controllers\Controller;
use App\Models\Membre;
use App\Services\OtpService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\ValidationException;

class MembreAuthController extends Controller
{
    protected function normalizePhone(string $countryCode, string $number): string
    {
        $digits = preg_replace('/\D/', '', $countryCode . $number);
        return $digits;
    }

    /**
     * Détermine l'indicatif pays par défaut selon l'emplacement (IP).
     */
    protected function getDefaultCountryAndDial(): array
    {
        $countryCode = GeoHelper::getCountryCodeFromIp('SN');
        $dialCode = GeoHelper::getDialCodeForCountry($countryCode);
        $countries = config('country_dial_codes', []);
        return [
            'country_code' => $countryCode,
            'dial_code' => $dialCode,
            'countries' => $countries,
        ];
    }

    /**
     * Afficher le formulaire de connexion (téléphone + mot de passe, indicatif pays)
     */
    public function showLoginForm()
    {
        $geo = $this->getDefaultCountryAndDial();
        return view('membres.login', [
            'default_country' => $geo['country_code'],
            'default_dial' => $geo['dial_code'],
            'countries' => $geo['countries'],
        ]);
    }

    /**
     * Traiter la connexion (par numéro de téléphone + mot de passe)
     */
    public function login(Request $request)
    {
        $request->validate([
            'country_code' => 'required|string|size:2',
            'telephone' => 'required|string|max:20',
            'password' => 'required',
        ]);

        $phoneNormalized = $this->normalizePhone(
            GeoHelper::getDialCodeForCountry($request->input('country_code')),
            $request->input('telephone')
        );

        if (strlen($phoneNormalized) < 8) {
            throw ValidationException::withMessages([
                'telephone' => ['Le numéro de téléphone est invalide.'],
            ]);
        }

        $membre = Membre::where('telephone', $phoneNormalized)->first();

        if (!$membre) {
            throw ValidationException::withMessages([
                'telephone' => ['Les identifiants fournis sont incorrects.'],
            ]);
        }

        if (!$membre->hasVerifiedEmail()) {
            $request->session()->flash('unverified_phone', $membre->telephone);
            throw ValidationException::withMessages([
                'telephone' => ['Vous devez vérifier votre numéro de téléphone avant de vous connecter. Un code OTP vous a été envoyé par SMS.'],
            ]);
        }

        if ($membre->statut !== 'actif') {
            throw ValidationException::withMessages([
                'telephone' => ['Votre compte est inactif. Veuillez contacter l\'administrateur.'],
            ]);
        }

        if (!Hash::check($request->input('password'), $membre->password)) {
            throw ValidationException::withMessages([
                'telephone' => ['Les identifiants fournis sont incorrects.'],
            ]);
        }

        Auth::guard('membre')->login($membre, $request->boolean('remember'));
        $request->session()->regenerate();

        return redirect()->intended(route('membre.dashboard'));
    }

    /**
     * Afficher le formulaire d'inscription (avec indicatif pays)
     */
    public function showRegisterForm()
    {
        $geo = $this->getDefaultCountryAndDial();
        return view('membres.register', [
            'default_country' => $geo['country_code'],
            'default_dial' => $geo['dial_code'],
            'countries' => $geo['countries'],
        ]);
    }

    /**
     * Traiter l'inscription : créer le membre puis envoyer un code OTP par SMS (au lieu du lien email)
     */
    public function register(Request $request)
    {
        $countryCode = $request->input('country_code', 'SN');
        $dialCode = GeoHelper::getDialCodeForCountry($countryCode);
        $phoneNormalized = $this->normalizePhone($dialCode, $request->input('telephone', ''));

        $validated = $request->validate([
            'nom' => 'required|string|max:255',
            'prenom' => 'required|string|max:255',
            'email' => 'required|email|max:255|unique:membres,email',
            'country_code' => 'required|string|size:2',
            'telephone' => 'required|string|max:20',
            'adresse' => 'nullable|string',
            'password' => 'required|string|min:6|confirmed',
        ]);

        if (strlen($phoneNormalized) < 8) {
            throw ValidationException::withMessages([
                'telephone' => ['Le numéro de téléphone est invalide.'],
            ]);
        }

        $existing = Membre::where('telephone', $phoneNormalized)->first();
        if ($existing) {
            throw ValidationException::withMessages([
                'telephone' => ['Ce numéro de téléphone est déjà utilisé.'],
            ]);
        }

        $validated['numero'] = $this->generateNumeroMembre();
        $validated['date_adhesion'] = now();
        $validated['statut'] = 'actif';
        $validated['password'] = Hash::make($validated['password']);
        $validated['telephone'] = $phoneNormalized;
        unset($validated['country_code']);

        $membre = Membre::create($validated);

        $activeGateway = \App\Models\SmsGateway::getActive();
        if (!$activeGateway) {
            // Aucune passerelle SMS active : pas d'envoi OTP, le membre poursuit sans être bloqué
            $membre->markEmailAsVerified();
            return redirect()->route('membre.login')
                ->with('success', 'Votre compte a été créé. Vous pouvez vous connecter avec votre numéro de téléphone et votre mot de passe.');
        }

        $otpService = app(OtpService::class);
        $code = $otpService->generateAndStore($phoneNormalized);
        $otpService->sendOtp($phoneNormalized, $code);

        $request->session()->put('membre_otp_phone', $phoneNormalized);
        $request->session()->put('membre_otp_membre_id', $membre->id);

        return redirect()->route('membre.verify-otp')
            ->with('success', 'Un code de vérification a été envoyé par SMS au ' . $dialCode . ' ' . $request->input('telephone') . '. Entrez-le ci-dessous.');
    }

    /**
     * Afficher la page de saisie du code OTP (après inscription)
     */
    public function showVerifyOtpForm(Request $request)
    {
        if (!$request->session()->has('membre_otp_phone')) {
            return redirect()->route('membre.register')
                ->with('error', 'Session expirée. Veuillez vous réinscrire.');
        }
        $phone = $request->session()->get('membre_otp_phone');
        $masked = strlen($phone) > 4 ? '***' . substr($phone, -4) : '***';
        return view('membres.verify-otp', ['phone_masked' => $masked]);
    }

    /**
     * Vérifier le code OTP et activer le compte (marquer email_verified_at)
     */
    public function verifyOtp(Request $request)
    {
        $request->validate([
            'otp' => 'required|string|size:6',
        ]);

        $phone = $request->session()->get('membre_otp_phone');
        $membreId = $request->session()->get('membre_otp_membre_id');

        if (!$phone || !$membreId) {
            return redirect()->route('membre.register')
                ->with('error', 'Session expirée. Veuillez vous réinscrire.');
        }

        $otpService = app(OtpService::class);
        if (!$otpService->verify($phone, $request->input('otp'))) {
            throw ValidationException::withMessages([
                'otp' => ['Code OTP invalide ou expiré. Demandez un nouveau code.'],
            ]);
        }

        $membre = Membre::findOrFail($membreId);
        $membre->markEmailAsVerified();

        $request->session()->forget(['membre_otp_phone', 'membre_otp_membre_id']);

        return redirect()->route('membre.login')
            ->with('success', 'Votre compte est activé. Connectez-vous avec votre numéro de téléphone et votre mot de passe.');
    }

    /**
     * Renvoyer un code OTP (depuis la page verify-otp)
     */
    public function resendOtp(Request $request)
    {
        $phone = $request->session()->get('membre_otp_phone');
        if (!$phone) {
            return redirect()->route('membre.register')->with('error', 'Session expirée.');
        }

        $otpService = app(OtpService::class);
        $code = $otpService->generateAndStore($phone);
        $otpService->sendOtp($phone, $code);

        return back()->with('success', 'Un nouveau code a été envoyé par SMS.');
    }

    /**
     * Vérifier l'email du membre via le lien reçu par mail (legacy, conservé pour compatibilité)
     */
    public function verifyEmail(Request $request)
    {
        $id = $request->route('id');
        $hash = $request->route('hash');

        $validated = validator(['id' => $id, 'hash' => $hash], [
            'id' => 'required|integer|exists:membres,id',
            'hash' => 'required|string',
        ])->validate();

        $membre = Membre::findOrFail($validated['id']);

        if (!hash_equals((string) $validated['hash'], sha1($membre->email))) {
            return redirect()->route('membre.login')
                ->with('error', 'Le lien de vérification est invalide ou a expiré.');
        }

        if ($membre->hasVerifiedEmail()) {
            return redirect()->route('membre.login')
                ->with('success', 'Votre compte est déjà vérifié. Vous pouvez vous connecter.');
        }

        $membre->markEmailAsVerified();

        return redirect()->route('membre.login')
            ->with('success', 'Votre compte a été vérifié. Vous pouvez vous connecter.');
    }

    /**
     * Renvoyer l'email de vérification (legacy)
     */
    public function resendVerification(Request $request)
    {
        $request->validate(['email' => 'required|email|exists:membres,email']);

        $membre = Membre::where('email', $request->email)->first();

        if ($membre->hasVerifiedEmail()) {
            return redirect()->route('membre.login')
                ->with('success', 'Votre compte est déjà vérifié.');
        }

        try {
            app(\App\Services\EmailService::class)->sendVerificationEmail($membre);
        } catch (\Exception $e) {
            \Illuminate\Support\Facades\Log::error('Renvoyer email vérification: ' . $e->getMessage());
            return redirect()->route('membre.login')
                ->with('error', 'Impossible d\'envoyer le lien. Vérifiez la configuration SMTP (Paramètres > SMTP).');
        }

        return redirect()->route('membre.login')
            ->with('success', 'Un nouveau lien de vérification a été envoyé à votre adresse email.');
    }

    private function generateNumeroMembre(): string
    {
        do {
            $numero = 'MEM-' . strtoupper(\Illuminate\Support\Str::random(6));
        } while (Membre::where('numero', $numero)->exists());
        return $numero;
    }

    /**
     * Déconnexion
     */
    public function logout(Request $request)
    {
        Auth::guard('membre')->logout();
        $request->session()->invalidate();
        $request->session()->regenerateToken();
        return redirect()->route('membre.login');
    }
}
